// Prisma Schema for Klinik Gigi Senyum Sejahtera
// Dental Clinic Booking System

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum RoleUser {
  PATIENT
  DOCTOR
  ADMIN
}

enum BookingStatus {
  PENDING // Menunggu pembayaran DP
  PAID // DP sudah dibayar
  CHECKED_IN // Pasien sudah datang
  COMPLETED // Perawatan selesai
  CANCELLED // Dibatalkan
  EXPIRED // Timeout pembayaran
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum GalleryCategory {
  BEFORE_AFTER
  CLINIC
  TEAM
}

enum BookingSource {
  PATIENT_ONLINE
  DOCTOR_PORTAL
  ADMIN_DASHBOARD
}

enum BookingType {
  WALK_IN
  PHONE
  REFERRAL
}

// ============================================
// AUTH MODELS (Auth.js compatible)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // Hashed password for credentials login
  phone         String? // WhatsApp number for notifications
  address       String? // Alamat pasien
  avatar        String? // URL foto profil (Supabase Storage)
  role          RoleUser  @default(PATIENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // App relations
  bookings      Booking[]
  doctorProfile Doctor?
  blogPosts     BlogPost[]

  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CLINIC MODELS
// ============================================

model Doctor {
  id              String   @id @default(cuid())
  userId          String?  @unique // Link to User account (optional)
  user            User?    @relation(fields: [userId], references: [id])
  name            String // e.g., "drg. Handoko"
  speciality      String // e.g., "Dokter Gigi Umum"
  bio             String? // Short description
  image           String // Photo URL (Supabase Storage)
  phone           String? // Contact number
  yearsExperience Int      @default(0) // Tahun pengalaman dokter
  rating          Decimal  @default(5.0) @db.Decimal(2, 1) // Rating dokter
  totalPatients   Int      @default(0) // Counter pasien yang ditangani
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  scheduleTemplates ScheduleTemplate[]
  timeSlots         TimeSlot[]
  bookings          Booking[]
  blockedDates      BlockedDate[]

  @@index([isActive])
}

model Service {
  id          String   @id @default(cuid())
  name        String // e.g., "Scaling & Polishing"
  slug        String   @unique // e.g., "scaling-polishing"
  description String? // Detailed description
  price       Int // Full price in IDR
  dpAmount    Int // Down payment amount in IDR
  duration    Int      @default(60) // Duration in minutes
  image       String? // Service image (Supabase Storage)
  category    String   @default("general") // general, cosmetic, orthodontic
  faq         Json? // FAQ specific untuk layanan ini
  isActive    Boolean  @default(true)
  order       Int      @default(0) // Display order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bookings Booking[]

  @@index([isActive, order])
  @@index([category])
}

model ScheduleTemplate {
  id           String    @id @default(cuid())
  doctorId     String
  doctor       Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  dayOfWeek    DayOfWeek
  startTime    String // "09:00"
  endTime      String // "17:00"
  slotDuration Int       @default(60) // minutes per slot
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([doctorId, dayOfWeek])
  @@index([doctorId])
}

model BlockedDate {
  id        String   @id @default(cuid())
  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  reason    String? // e.g., "Cuti", "Training"
  createdAt DateTime @default(now())

  @@unique([doctorId, date])
  @@index([doctorId, date])
}

model TimeSlot {
  id          String   @id @default(cuid())
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id])
  date        DateTime @db.Date
  startTime   String // "09:00"
  endTime     String // "10:00"
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  booking Booking?

  @@unique([doctorId, date, startTime])
  @@index([doctorId, date, isAvailable])
  @@index([date, isAvailable])
}

model Booking {
  id   String @id @default(cuid())
  code String @unique // e.g., "DENT-ABC123"

  // Patient info
  patientId    String
  patient      User   @relation(fields: [patientId], references: [id])
  patientName  String // Denormalized for quick access
  patientPhone String // WhatsApp number for notifications

  // Appointment info
  doctorId        String
  doctor          Doctor   @relation(fields: [doctorId], references: [id])
  serviceId       String
  service         Service  @relation(fields: [serviceId], references: [id])
  slotId          String   @unique
  slot            TimeSlot @relation(fields: [slotId], references: [id])
  appointmentDate DateTime @db.Date
  appointmentTime String // "09:00"

  // Booking source info
  bookingSource BookingSource @default(PATIENT_ONLINE)
  bookingType   BookingType? // For DOCTOR_PORTAL / ADMIN bookings

  // Payment info
  dpAmount   Int @default(0) // DP yang harus dibayar
  dpPaid     Int @default(0) // DP yang sudah dibayar
  totalPrice Int // Harga penuh layanan

  // Status & timestamps
  status        BookingStatus @default(PENDING)
  notes         String? // Keluhan pasien
  tokenMidtrans String?
  paidAt        DateTime?
  checkedInAt   DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  expiresAt     DateTime // Payment timeout (15 min from creation)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Notifications tracking
  confirmationSent Boolean @default(false)
  reminderSent     Boolean @default(false)

  @@index([patientId])
  @@index([patientId, status])
  @@index([doctorId, appointmentDate])
  @@index([status])
  @@index([appointmentDate])
  @@index([expiresAt, status])
}

model ClinicSettings {
  id               String   @id @default("default")
  clinicName       String   @default("Klinik Gigi Senyum Sejahtera")
  address          String?
  phone            String?
  email            String?
  whatsappNumber   String? // For Fonnte
  operationalHours String? // JSON string
  paymentTimeout   Int      @default(15) // minutes
  reminderHours    Int      @default(24) // hours before appointment
  updatedAt        DateTime @updatedAt
}

// ============================================
// CONTENT MODELS
// ============================================

model GalleryImage {
  id        String          @id @default(cuid())
  title     String?
  imageUrl  String
  category  GalleryCategory
  order     Int             @default(0)
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([category, isActive])
}

model BlogPost {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String
  content     String    @db.Text
  thumbnail   String?
  category    String
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
  publishedAt DateTime?
  isPublished Boolean   @default(false)
  viewCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isPublished, publishedAt])
  @@index([category])
  @@index([slug])
}

model ContactSubmission {
  id        String    @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String    @db.Text
  isRead    Boolean   @default(false)
  repliedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([isRead])
}
